<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>프라시아 카드 뷰어 (Excel + TTF)</title>
<style>
  /* ▼ PRASIA: TTF만 사용 */
  @font-face{
    font-family:'PRASIA';
    src: url('./fonts/PRASIA.ttf') format('truetype');
    font-display: swap;
  }

  :root{
    --bg:#0f1115; --fg:#e6e6e6; --muted:#9aa0a6; --accent:#e2c89d;
    --card-w:288px; --card-h:371px; --radius:14px; --gap:14px;

    /* 위치 변수(미세조정 쉬움) */
    --line-top: 60%;
    --line-bottom: 74%;
    --lvnick-top: 70%;
    --lv-left: 60px;
    --nick-right: 70px;
    --rune-top: 80%;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--fg);
       font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Noto Sans KR,sans-serif;}

  header{
    position:sticky;top:0;z-index:10;
    display:flex;align-items:center;justify-content:space-between;
    padding:12px 16px;background:rgba(15,17,21,.82);
    border-bottom:1px solid #222; backdrop-filter: blur(6px);
  }
  .title{font-weight:700;letter-spacing:.2px}
  .btn{cursor:pointer;padding:8px 12px;border:1px solid #333;border-radius:10px;background:#1a1d23;color:#ddd}
  .btn:hover{background:#222}

  main{max-width:1600px;margin:0 auto;padding:16px}
  .grid{
    display:grid;grid-template-columns:repeat(5,minmax(200px,1fr));
    gap:var(--gap);justify-items:center;
  }
  @media (max-width:1200px){ .grid{grid-template-columns:repeat(4,1fr);} }
  @media (max-width:920px) { .grid{grid-template-columns:repeat(3,1fr);} }
  @media (max-width:680px) { .grid{grid-template-columns:repeat(2,1fr);} }

  .card{width:var(--card-w);height:var(--card-h);perspective:1000px;}
  .inner{position:relative;width:100%;height:100%;transition:transform .6s;transform-style:preserve-3d;}
  .card.flipped .inner{transform:rotateY(180deg);}
  .face{position:absolute;inset:0;border-radius:var(--radius);overflow:hidden;
        backface-visibility:hidden;box-shadow:0 10px 30px rgba(0,0,0,.35);}

  .front{background:#181a1f;display:flex;align-items:flex-start;justify-content:center;padding:16px;}
  .front .canvas{
    position:relative; width:100%; height:100%;
    background:#15161a;
    background-size: cover;           /* 카드에 가득 채움 */
    background-position: center;
    border:1px solid #2a2d36; border-radius:12px;
  }

  .line{ position:absolute; left:20px; right:20px; height:24px;
         border-bottom:2px solid #b8a27c33; border-radius:12px; }
  .line.top{ top: var(--line-top); }
  .line.bottom{ top: var(--line-bottom); }

  /* 레벨/닉네임: 같은 줄 좌/우 배치 (텍스트: '토벌레벨') */
  .level{
    position:absolute; top: var(--lvnick-top); left: var(--lv-left); transform:translateY(-50%);
    font-weight:700; color:#c9c9c9; text-shadow:0 1px 2px rgba(0,0,0,.6);
  }
  .nickname{
    position:absolute; top: var(--lvnick-top); right: var(--nick-right); transform:translateY(-50%);
    color:#c9c9c9; text-shadow:0 1px 2px rgba(0,0,0,.6);
  }
  /* 룬문자 */
  .rune{
    position:absolute; top: var(--rune-top); left:24px; right:24px; transform:translateY(-50%);
    text-align:center; font-family:'PRASIA', system-ui, sans-serif;
    font-size:13px; letter-spacing:.07em; color:var(--accent);
    text-shadow:0 1px 2px rgba(0,0,0,.6);
  }

  .back{background:#14161b;transform:rotateY(180deg);padding:18px;display:flex;flex-direction:column;gap:10px;}
  .stat{display:flex;justify-content:space-between;background:#0f1115;border:1px solid #2a2d36;border-radius:10px;padding:10px 12px;}
  .stat .k{color:#cdb88f}
  .empty{display:flex;align-items:center;justify-content:center;color:#666;border:1px dashed #333}

  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.55);z-index:20}
  .modal.show{display:flex}
  .panel{width:min(780px,96vw);max-height:90vh;overflow:auto;border:1px solid #2a2d36;background:#0f1115;border-radius:14px;padding:16px;}
  .row{display:grid;grid-template-columns:160px 1fr;gap:12px;align-items:center;margin:6px 0}
  .row input,.row select,.row textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #333;background:#15171d;color:#ddd}
  .row textarea{min-height:70px}
  .toolbar{display:flex;gap:10px;justify-content:flex-end;margin-top:10px}
  .hint{color:#9ba3af;font-size:13px}
</style>
<!-- SheetJS: 브라우저에서 엑셀 읽기 -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
  <header>
    <div class="title">프라시아 카드 뷰어</div>
    <button id="adminBtn" class="btn">관리자모드</button>
  </header>

  <main>
    <div id="grid" class="grid"></div>
  </main>

  <!-- 관리자 모달 (엑셀 모드: 저장 버튼은 안내만) -->
  <div id="modal" class="modal">
    <div class="panel">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:10px">
        <h3 style="margin:0">관리자 패널</h3>
        <div class="hint">엑셀 참조 모드: 브라우저에서 직접 저장은 불가 (시트 수정 후 새로고침)</div>
      </div>

      <div id="loginBox" class="row">
        <label>관리자 비밀번호</label>
        <input id="adminPass" type="password" placeholder="비밀번호 입력" />
      </div>

      <div id="adminForm" style="display:none">
        <hr style="border-color:#222;margin:12px 0">
        <h4 style="margin:6px 0">카드(캐릭터) 편집 미리보기</h4>
        <div class="row"><label>카드 선택</label><select id="cardSelect"></select></div>
        <div class="row"><label>클래스명</label><input id="className" /></div>
        <div class="row"><label>토벌레벨</label><input id="level" type="number" min="0" value="0" /></div>
        <div class="row"><label>닉네임</label><input id="nickname" /></div>
        <div class="row"><label>룬문자</label><input id="runeText" /></div>
        <div class="row"><label>공격</label><input id="atk" type="number" value="0"></div>
        <div class="row"><label>방어</label><input id="def" type="number" value="0"></div>
        <div class="row"><label>명중</label><input id="acc" type="number" value="0"></div>
        <div class="row"><label>3대합</label><input id="trinity" type="number" value="0"></div>
        <div class="row"><label>전투력</label><input id="power" type="number" value="0"></div>
        <div class="toolbar">
          <button id="saveBtn" class="btn">저장(안내)</button>
          <button id="closeBtn" class="btn">닫기</button>
        </div>
      </div>
    </div>
  </div>

<script>
/* =========================
   1) 엑셀 경로/시트
   ========================= */
const EXCEL_PATH = './data/cards.xlsx';     // 엑셀 파일
const EXCEL_SHEET_INDEX = 0;                // 첫 번째 시트 사용

/* 상태 */
let rows = [];  // {class, nickname, tlevel, rune, atk, def, acc, trinity, power}
let adminPassword = null;

/* 유틸: 클래스 이미지 경로(없으면 규칙으로) */
const imageFor = (klass) => `./assets/classes/${klass}_카드.png`;

/* 시작 */
document.addEventListener('DOMContentLoaded', async () => {
  await loadFromExcel();
  renderGrid();
  setupAdminUI();
});

/* =========================
   2) Excel 로드 (A~I 열 고정 매핑)
   A: 클래스, B: 닉네임, C: 토벌레벨, D: 룬문자,
   E: 공격, F: 방어, G: 명중, H: 3대합, I: 전투력
   ========================= */
async function loadFromExcel(){
  try{
    const res = await fetch(EXCEL_PATH);
    if(!res.ok) throw new Error('엑셀 파일을 불러올 수 없습니다.');
    const buf = await res.arrayBuffer();
    const wb  = XLSX.read(buf, { type:'array' });

    const ws = wb.Sheets[wb.SheetNames[EXCEL_SHEET_INDEX]];
    // 헤더 1행은 건너뛰고, A~I를 고정 키로 매핑
    const data = XLSX.utils.sheet_to_json(ws, {
      header: ['class','nickname','tlevel','rune','atk','def','acc','trinity','power'],
      range: 1,     // 0-based: 1 → 2행부터 데이터
      defval: ''
    });

    rows = data.map(r => ({
      class: String(r.class).trim(),
      nickname: String(r.nickname).trim(),
      tlevel: parseInt(r.tlevel||0,10) || 0,
      rune: String(r.rune).trim(),
      atk: parseInt(r.atk||0,10) || 0,
      def: parseInt(r.def||0,10) || 0,
      acc: parseInt(r.acc||0,10) || 0,
      trinity: parseInt(r.trinity||0,10) || 0,
      power: parseInt(r.power||0,10) || 0,
    })).filter(x => x.class || x.nickname); // 완전 빈 행 제거
  }catch(e){
    console.error(e);
    alert('엑셀 읽기 실패: ' + e.message);
    rows = [];
  }
}

/* =========================
   3) 그리드 렌더 (5×10)
   ========================= */
function renderGrid(){
  const $g = document.getElementById('grid');
  $g.innerHTML = '';

  const total = 50;
  for (let i=0; i<total; i++){
    const row = rows[i];
    const $card = document.createElement('div');
    $card.className = 'card';
    const $inner = document.createElement('div'); $inner.className = 'inner';

    // 앞면
    const $front = document.createElement('div'); $front.className = 'face front';
    const $canvas= document.createElement('div'); $canvas.className = 'canvas';

    if (row){
      const img = imageFor(row.class);
      $canvas.style.backgroundImage = `url("${img}")`;

      // 라인 + 텍스트 (토벌레벨)
      const lt=document.createElement('div'); lt.className='line top';
      const lb=document.createElement('div'); lb.className='line bottom';
      const lv=document.createElement('div'); lv.className='level'; lv.textContent=`토벌 ${row.tlevel}`;
      const nk=document.createElement('div'); nk.className='nickname'; nk.textContent=row.nickname;
      const rn=document.createElement('div'); rn.className='rune'; rn.textContent=row.rune||'';
      $canvas.append(lt,lb,lv,nk,rn);
    } else {
      $canvas.classList.add('empty'); $canvas.textContent='빈 칸';
    }
    $front.appendChild($canvas);

    // 뒷면
    const $back = document.createElement('div'); $back.className='face back';
    if (row){
      $back.appendChild(statRow('공격', row.atk));
      $back.appendChild(statRow('방어', row.def));
      $back.appendChild(statRow('명중', row.acc));
      $back.appendChild(statRow('3대합', row.trinity));
      $back.appendChild(statRow('전투력', row.power));
    } else {
      const d=document.createElement('div'); d.className='empty'; d.textContent='데이터 없음'; $back.appendChild(d);
    }

    $inner.append($front,$back);
    $card.appendChild($inner);
    $card.addEventListener('click', ()=> $card.classList.toggle('flipped'));
    $g.appendChild($card);
  }
}
function statRow(k,v){
  const x=document.createElement('div'); x.className='stat';
  const a=document.createElement('div'); a.className='k'; a.textContent=k;
  const b=document.createElement('div'); b.textContent=(v??0).toLocaleString();
  x.append(a,b); return x;
}

/* =========================
   4) 관리자 UI (엑셀 모드: 읽기 전용)
   ========================= */
function setupAdminUI(){
  const $modal = document.getElementById('modal');
  const $btn   = document.getElementById('adminBtn');
  const $loginBox = document.getElementById('loginBox');
  const $adminForm= document.getElementById('adminForm');
  const $pass  = document.getElementById('adminPass');
  const $close = document.getElementById('closeBtn');

  $btn.addEventListener('click', ()=>{ $modal.classList.add('show'); $pass.focus(); buildCardSelect(); });
  $close.addEventListener('click', ()=>{ $modal.classList.remove('show'); });

  $pass.addEventListener('change', ()=>{
    adminPassword = $pass.value.trim();
    if (adminPassword){ $loginBox.style.display='none'; $adminForm.style.display='block'; }
  });

  function buildCardSelect(){
    const $sel = document.getElementById('cardSelect');
    $sel.innerHTML = '';
    const optNew = document.createElement('option'); optNew.value=''; optNew.textContent='카드 선택';
    $sel.appendChild(optNew);
    rows.forEach((r,idx)=>{
      const o=document.createElement('option');
      o.value=String(idx);
      o.textContent=`${r.nickname} (토벌레벨 ${r.tlevel})`;
      $sel.appendChild(o);
    });
    $sel.addEventListener('change', ()=>{
      const r = rows[parseInt($sel.value||'-1',10)];
      document.getElementById('className').value = r ? r.class : '';
      document.getElementById('level').value     = r ? r.tlevel : 0;
      document.getElementById('nickname').value  = r ? r.nickname : '';
      document.getElementById('runeText').value  = r ? (r.rune||'') : '';
      document.getElementById('atk').value       = r ? (r.atk||0) : 0;
      document.getElementById('def').value       = r ? (r.def||0) : 0;
      document.getElementById('acc').value       = r ? (r.acc||0) : 0;
      document.getElementById('trinity').value   = r ? (r.trinity||0) : 0;
      document.getElementById('power').value     = r ? (r.power||0) : 0;
    });
  }

  document.getElementById('saveBtn').addEventListener('click', ()=>{
    alert('엑셀 참조 모드에서는 브라우저에서 저장할 수 없어요.\n엑셀 파일(data/cards.xlsx)을 수정한 뒤 페이지를 새로고침하세요!');
  });
}
</script>
</body>
</html>
